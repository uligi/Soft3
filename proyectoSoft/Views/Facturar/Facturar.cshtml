@{
    ViewBag.Title = "Facturar Carga";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<ol class="breadcrumb mb-4 mt-4">
    <li class="breadcrumb-item"><a href="index.html">Administrar</a></li>
    <li class="breadcrumb-item active">Facturar Carga</li>
</ol>

<div class="card">
    <div class="card-header">
        <i class="fas fa-file-invoice-dollar me-1"></i> Facturar Carga
    </div>
    <div class="card-body">
        <div class="row">
            <!-- Información de la Factura -->
            <input id="CotizarCargaID" type="hidden" value="0" />
            <input id="DetalleFacturaID" type="hidden" value="0" />
            <div class="col-md-6">
                <h5>Información del Cliente</h5>
                <div class="form-group">
                    <label for="cedulaCliente">Cédula del Cliente</label>
                    <input type="text" class="form-control" id="cedulaCliente" readonly style="background-color: #e9ecef;">
                </div>
                <div class="form-group">
                    <label for="nombreCliente">Nombre del Cliente</label>
                    <input type="text" class="form-control" id="nombreCliente" readonly style="background-color: #e9ecef;">
                </div>
                <div class="form-group">
                    <label for="apellido1Cliente">Primer Apellido</label>
                    <input type="text" class="form-control" id="apellido1Cliente" readonly style="background-color: #e9ecef;">
                </div>
                <div class="form-group">
                    <label for="apellido2Cliente">Segundo Apellido</label>
                    <input type="text" class="form-control" id="apellido2Cliente" readonly style="background-color: #e9ecef;">
                </div>
                <div class="form-group">
                    <label for="correoCliente">Correo</label>
                    <input type="text" class="form-control" id="correoCliente" readonly style="background-color: #e9ecef;">
                </div>
                <h5>Información de la Carga</h5>
                <div class="form-group">
                    <label for="tipoCarga">Tipo de Carga</label>
                    <input type="text" class="form-control" id="tipoCarga" readonly style="background-color: #e9ecef;">
                </div>
                <div class="form-group">
                    <label for="precioPorPeso">Precio por Peso (₡)</label>
                    <input type="text" class="form-control" id="precioPorPeso" readonly style="background-color: #e9ecef;">
                </div>
                <div class="form-group">
                    <label for="cantidad">Cantidad (Kg)</label>
                    <input type="number" class="form-control" id="cantidad">
                </div>
            </div>

            <!-- Detalles de la Factura -->
            <div class="col-md-6">
                <h5>Detalles de la Factura</h5>
                <div class="form-group">
                    <label for="subTotalGravado">SubTotal Gravado (₡)</label>
                    <input type="text" class="form-control" id="subTotalGravado" readonly style="background-color: #e9ecef;">
                </div>
                <div class="form-group">
                    <label for="totalSinDescuento">Total Sin Descuento (₡)</label>
                    <input type="text" class="form-control" id="totalSinDescuento" readonly style="background-color: #e9ecef;">
                </div>
                <div class="form-group">
                    <label for="totalConDescuento">Total con Descuento (₡)</label>
                    <input type="text" class="form-control" id="totalConDescuento" readonly style="background-color: #e9ecef;">
                </div>
                <div class="form-group">
                    <label for="totalImpuesto">Total Impuesto (₡)</label>
                    <input type="text" class="form-control" id="totalImpuesto" readonly style="background-color: #e9ecef;">
                </div>
                <div class="form-group">
                    <label for="totalComprobante">Total Comprobante (₡)</label>
                    <input type="text" class="form-control" id="totalComprobante" readonly style="background-color: #e9ecef;">
                </div>
                <h5>Representante</h5>
                <div class="form-group">
                    <label for="representante">Nombre</label>
                    <input type="text" class="form-control" id="representante" readonly style="background-color: #e9ecef;">
                </div>
                <button type="button" class="btn btn-primary mt-2" onclick="guardarFactura()">Guardar Factura</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            cargarDatosFactura();
        });

        function cargarDatosFactura() {
            var facturaData = JSON.parse(localStorage.getItem('facturaData'));
            if (facturaData) {
                // Asignar los datos al formulario
                $("#cedulaCliente").val(facturaData.CedulaCliente);
                $("#nombreCliente").val(facturaData.NombreCliente);
                $("#apellido1Cliente").val(facturaData.Apellido1Cliente);
                $("#apellido2Cliente").val(facturaData.Apellido2Cliente);
                $("#correoCliente").val(facturaData.CorreoCliente);
                $("#tipoCarga").val(facturaData.TipoCarga);
                $("#representante").val(facturaData.Representante);
                $("#precioPorPeso").val(facturaData.PrecioPorPeso);
                $("#cantidad").val(facturaData.Cantidad);

                // Cargar los valores iniciales de los detalles de la factura
                calcularFactura();
            } else {
                swal("Error", "No se encontraron datos de la cotización seleccionada.", "error");
            }
        }

        function calcularFactura() {
            var precioPorPeso = parseFloat($("#precioPorPeso").val());
            var cantidad = parseFloat($("#cantidad").val());
            var subTotalGravado = precioPorPeso * cantidad;
            var totalDescuento = parseFloat($("#descuento").val());
            var totalImpuesto = parseFloat($("#totalImpuesto").val());
            var totalComprobante = parseFloat($("#totalComprobante").val());

            // Asignar valores a los campos de la factura
            $("#subTotalGravado").val(subTotalGravado.toFixed(2));
            $("#totalSinDescuento").val(subTotalGravado.toFixed(2));

            // Calcular el total con descuento
            var totalConDescuento = subTotalGravado - totalDescuento;
            $("#totalConDescuento").val(totalConDescuento.toFixed(2));

            // Calcular el total impuesto
            var impuesto = totalConDescuento * (totalImpuesto / totalComprobante);
            $("#totalImpuesto").val(impuesto.toFixed(2));

            // Calcular el total comprobante
            var totalFinal = totalConDescuento + impuesto;
            $("#totalComprobante").val(totalFinal.toFixed(2));
        }

        function guardarFactura() {
            // Mostrar SweetAlert de confirmación
            swal({
                title: "¿Estás seguro?",
                text: "Vas a guardar esta factura.",
                type: "warning",
                showCancelButton: true,
                confirmButtonClass: "btn-primary",
                confirmButtonText: "Sí, guardar",
                cancelButtonText: "Cancelar",
                closeOnConfirm: false
            }, function () {
                // Recolectar datos de los campos
                var factura = {
                    DetalleFacturaID: parseInt($("#DetalleFacturaID").val()),
                    CotizarCargaID: parseInt($("#CotizarCargaID").val()), // Obtener el ID de la cotización
                    UsuarioID: obtenerUsuarioID(), // Obtener el ID del usuario (representante)
                    PrecioPorPeso: parseFloat($("#precioPorPeso").val()),
                    Cantidad: parseInt($("#cantidad").val()),
                    SubTotalGravado: parseFloat($("#subTotalGravado").val()),
                    TotalSinDescuento: parseFloat($("#totalSinDescuento").val()),
                    TotalConDescuento: parseFloat($("#totalConDescuento").val()),
                    TotalImpuesto: parseFloat($("#totalImpuesto").val()),
                    TotalComprobante: parseFloat($("#totalComprobante").val()),
                    Activo: true
                };

                // Validación básica
                if (isNaN(factura.CotizarCargaID) || isNaN(factura.UsuarioID) || isNaN(factura.PrecioPorPeso) || isNaN(factura.Cantidad)) {
                    swal("Error", "Por favor, complete todos los campos requeridos.", "error");
                    return;
                }

                // Envío de datos al servidor
                $.ajax({
                    url: '@Url.Action("GuardarFactura", "Factura")',
                    type: "POST",
                    data: JSON.stringify(factura),
                    dataType: "json",
                    contentType: "application/json; charset=utf-8",
                    success: function (data) {
                        if (data.resultado == 0) {
                            swal({
                                title: "Éxito",
                                text: "Factura guardada exitosamente.",
                                type: "success"
                            }, function () {
                                window.location.href = '@Url.Action("Facturas", "Factura")';
                            });
                        } else {
                            swal("Error", "Error al guardar la factura: " + data.mensaje, "error");
                        }
                    },
                    error: function (error) {
                        swal("Error", "Error en la solicitud AJAX: " + error.responseText, "error");
                    }
                });
            });
        }

        function obtenerUsuarioID() {
            // Obtener el ID del usuario desde la sesión o asignarlo según la lógica del sistema
            return @Session["UsuarioID"];
        }
    </script>
}
