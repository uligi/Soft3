@{
    ViewBag.Title = "Cotizar Carga";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<ol class="breadcrumb mb-4 mt-4">
    <li class="breadcrumb-item"><a href="index.html">Administrar</a></li>
    <li class="breadcrumb-item active">Cotizar Carga</li>
</ol>

<div class="card">
    <div class="card-header">
        <i class="fas fa-box-open me-1"></i> Cotizar Carga
    </div>
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-4">
                <label for="cliente" class="form-label">Cliente</label>
                <select class="form-select" id="cliente">
                    <option selected value="0">Seleccione un Cliente</option>
                </select>
            </div>
            <div class="col-md-4">
                <label for="tipoCarga" class="form-label">Tipo de Carga</label>
                <select class="form-select" id="tipoCarga">
                    <option selected value="0">Seleccione un Tipo de Carga</option>
                </select>
            </div>
            <div class="col-md-4">
                <label for="peso" class="form-label">Peso (kg)</label>
                <input type="number" class="form-control" id="peso" step="0.01">
            </div>
        </div>

        <hr />

        <div class="row g-3">
            <div class="col-md-4">
                <label for="descuento" class="form-label">Descuento</label>
                <input type="text" class="form-control" id="descuento" readonly>
            </div>
            <div class="col-md-4">
                <label for="impuesto" class="form-label">Impuesto</label>
                <input type="text" class="form-control" id="impuesto" readonly>
            </div>
            <div class="col-md-4">
                <label for="total" class="form-label">Total</label>
                <input type="text" class="form-control" id="total" readonly>
            </div>
        </div>

        <div class="row g-3 mt-3">
            <div class="col-md-4">
                <button type="button" class="btn btn-secondary" onclick="agregarImpuesto()">Agregar Impuesto</button>
            </div>
            <div class="col-md-4">
                <button type="button" class="btn btn-secondary" onclick="agregarDescuento()">Agregar Descuento</button>
            </div>
        </div>

        <hr />

        <div class="row g-3">
            <div class="col-md-4">
                <label for="direccion" class="form-label">Dirección</label>
                <select class="form-select" id="direccion">
                    <option selected value="0">Seleccione una Dirección</option>
                </select>
            </div>
            <div class="col-md-4">
                <label for="telefono" class="form-label">Teléfono</label>
                <select class="form-select" id="telefono">
                    <option selected value="0">Seleccione un Teléfono</option>
                </select>
            </div>
        </div>

        <hr />

        <button type="button" class="btn btn-primary" onclick="cotizar()">Cotizar</button>
    </div>
</div>

<div class="card mt-4" id="cardFactura" style="display: none;">
    <div class="card-header">
        <i class="fas fa-receipt me-1"></i> Factura Preliminar
    </div>
    <div class="card-body">
        <p><strong>Cliente:</strong> <span id="facturaCliente"></span></p>
        <p><strong>Dirección:</strong> <span id="facturaDireccion"></span></p>
        <p><strong>Teléfono:</strong> <span id="facturaTelefono"></span></p>
        <p><strong>Fecha:</strong> <span id="facturaFecha"></span></p>
        <table class="table">
            <thead>
                <tr>
                    <th>Tipo de Carga</th>
                    <th>Peso</th>
                    <th>Tarifa por Kilo</th>
                    <th>Subtotal</th>
                </tr>
            </thead>
            <tbody id="facturaDetalle">
            </tbody>
        </table>
        <p><strong>Total:</strong> <span id="facturaTotal"></span></p>
        <button type="button" class="btn btn-success" onclick="confirmarCotizacion()">Confirmar Cotización</button>
        <button type="button" class="btn btn-danger" onclick="descartarCotizacion()">Descartar Cotización</button>
    </div>
</div>

@section scripts {
    <script>
        var clientes = [];
        var tiposDeCarga = [];
        var direcciones = [];
        var telefonos = [];
        var cotizacion = {};

        $(document).ready(function () {
            cargarClientes();
            cargarTiposDeCarga();
        });

        function cargarClientes() {
            $.ajax({
                url: '@Url.Action("ListarClientes", "Gestionar")',
                type: "GET",
                success: function (data) {
                    clientes = data.data;
                    let clienteSelect = $("#cliente");
                    clienteSelect.empty();
                    clienteSelect.append('<option selected value="0">Seleccione un Cliente</option>');
                    $.each(clientes, function (index, item) {
                        clienteSelect.append($('<option>', {
                            value: item.ClienteID,
                            text: item.Nombre
                        }));
                    });
                }
            });
        }

        function cargarTiposDeCarga() {
            $.ajax({
                url: '@Url.Action("ListarTiposDeCarga", "Gestionar")',
                type: "GET",
                success: function (data) {
                    tiposDeCarga = data.data;
                    let tipoCargaSelect = $("#tipoCarga");
                    tipoCargaSelect.empty();
                    tipoCargaSelect.append('<option selected value="0">Seleccione un Tipo de Carga</option>');
                    $.each(tiposDeCarga, function (index, item) {
                        tipoCargaSelect.append($('<option>', {
                            value: item.TiposDeCargaID,
                            text: item.Nombre
                        }));
                    });
                }
            });
        }

        $("#cliente").change(function () {
            var clienteID = $(this).val();
            cargarDirecciones(clienteID);
            cargarTelefonos(clienteID);
        });

        function cargarDirecciones(clienteID) {
            $.ajax({
                url: '@Url.Action("ListarDireccionesPorCliente", "Gestionar")',
                type: "GET",
                data: { clienteID: clienteID },
                success: function (data) {
                    direcciones = data.data;
                    let direccionSelect = $("#direccion");
                    direccionSelect.empty();
                    direccionSelect.append('<option selected value="0">Seleccione una Dirección</option>');
                    $.each(direcciones, function (index, item) {
                        direccionSelect.append($('<option>', {
                            value: item.DireccionID,
                            text: item.NombreDireccion
                        }));
                    });
                }
            });
        }

        function cargarTelefonos(clienteID) {
            $.ajax({
                url: '@Url.Action("ListarTelefonosPorCliente", "Gestionar")',
                type: "GET",
                data: { clienteID: clienteID },
                success: function (data) {
                    telefonos = data.data;
                    let telefonoSelect = $("#telefono");
                    telefonoSelect.empty();
                    telefonoSelect.append('<option selected value="0">Seleccione un Teléfono</option>');
                    $.each(telefonos, function (index, item) {
                        telefonoSelect.append($('<option>', {
                            value: item.TelefonoID,
                            text: item.Numero
                        }));
                    });
                }
            });
        }

        $("#peso").change(function () {
            calcularTotal();
        });

        $("#tipoCarga").change(function () {
            calcularTotal();
        });

        function calcularTotal() {
            var tipoCargaID = $("#tipoCarga").val();
            var peso = parseFloat($("#peso").val());
            if (!tipoCargaID || !peso) return;

            var tipoCarga = tiposDeCarga.find(t => t.TiposDeCargaID == tipoCargaID);
            var subtotal = tipoCarga.TarifaPorKilo * peso;

            var descuento = 0;
            if (subtotal >= 100000 && subtotal < 200000) {
                descuento = subtotal * 0.05;
            } else if (subtotal >= 200000) {
                descuento = subtotal * 0.1;
            }

            var impuesto = (subtotal - descuento) * 0.11;
            var total = subtotal - descuento + impuesto;

            $("#descuento").val(descuento.toFixed(2));
            $("#impuesto").val(impuesto.toFixed(2));
            $("#total").val(total.toFixed(2));
        }

        function agregarImpuesto() {
            // Implementa la lógica para agregar otro impuesto.
        }

        function agregarDescuento() {
            // Implementa la lógica para agregar otro descuento.
        }

        function cotizar() {
            var tipoCargaID = $("#tipoCarga").val();
            var peso = parseFloat($("#peso").val());
            var tipoCarga = tiposDeCarga.find(t => t.TiposDeCargaID == tipoCargaID);
            var subtotal = tipoCarga.TarifaPorKilo * peso;

            var clienteID = $("#cliente").val();
            var direccionID = $("#direccion").val();
            var telefonoID = $("#telefono").val();
            var fecha = new Date().toISOString().slice(0, 10);

            cotizacion = {
                ClienteID: clienteID,
                DireccionID: direccionID,
                TelefonoID: telefonoID,
                Fecha: fecha,
                Total: parseFloat($("#total").val()),
                Descuento: parseFloat($("#descuento").val()),
                Impuesto: parseFloat($("#impuesto").val()),
                Detalle: [{
                    TipoCarga: tipoCarga.Nombre,
                    Peso: peso,
                    TarifaPorKilo: tipoCarga.TarifaPorKilo,
                    Subtotal: subtotal
                }]
            };

            mostrarFactura();
        }

        function mostrarFactura() {
            $("#facturaCliente").text(clientes.find(c => c.ClienteID == cotizacion.ClienteID).Nombre);
            $("#facturaDireccion").text(direcciones.find(d => d.DireccionID == cotizacion.DireccionID).NombreDireccion);
            $("#facturaTelefono").text(telefonos.find(t => t.TelefonoID == cotizacion.TelefonoID).Numero);
            $("#facturaFecha").text(cotizacion.Fecha);
            $("#facturaTotal").text(cotizacion.Total.toFixed(2));

            var detalle = cotizacion.Detalle[0];
            var detalleHtml = `<tr>
                <td>${detalle.TipoCarga}</td>
                <td>${detalle.Peso.toFixed(2)}</td>
                <td>${detalle.TarifaPorKilo.toFixed(2)}</td>
                <td>${detalle.Subtotal.toFixed(2)}</td>
            </tr>`;
            $("#facturaDetalle").html(detalleHtml);

            $("#cardFactura").show();
        }

        function confirmarCotizacion() {
            $.ajax({
                url: '@Url.Action("ConfirmarCotizacion", "Gestionar")',
                type: "POST",
                data: JSON.stringify(cotizacion),
                dataType: "json",
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    if (data.resultado) {
                        alert("Cotización confirmada y factura generada con éxito.");
                        location.reload();
                    } else {
                        alert("Error: " + data.mensaje);
                    }
                },
                error: function (error) {
                    alert("Error: " + error);
                }
            });
        }

        function descartarCotizacion() {
            $("#cardFactura").hide();
        }
    </script>
}
